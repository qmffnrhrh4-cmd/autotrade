# OpenAPI 데이터 수집 테스트 실행 가이드

## 🚀 실행 방법

### 1단계: kiwoom32 환경 활성화
```bash
conda activate kiwoom32
```

### 2단계: 테스트 파일 실행

#### Option A: 간단한 테스트 (4가지 데이터)
```bash
python test_stock_simple.py
```

**수집 데이터:**
- 마스터 정보 (종목명, 현재가, 상장주식수)
- 주식기본정보 (opt10001)
- 일봉차트 (opt10081) - 최근 10일
- 호가잔량 (opt10004)

**예상 실행 시간:** 약 30초

#### Option B: 종합 테스트 (20가지 데이터) ⭐ 권장
```bash
python test_stock_comprehensive_20.py
```

**수집 데이터:** 20가지 종합 데이터
**예상 실행 시간:** 약 1-2분

#### Option C: 기본 정보만 테스트
```bash
python test_kiwoom_direct.py
```

**수집 데이터:** 로그인 정보, 종목 마스터 정보만
**예상 실행 시간:** 약 10초

---

## 📋 실행 과정

### 1. 로그인 창 표시
```
====================================================================================
  종목별 20가지 데이터 종합 수집
====================================================================================

🔧 API 초기화...
🔐 로그인 중...
```

👉 **키움증권 로그인 창이 뜹니다. 로그인하세요.**

### 2. 로그인 성공
```
✅ 로그인 성공!
```

### 3. 데이터 수집 시작
```
====================================================================================
  종목: 005930 (삼성전자)
====================================================================================

📊 1. 마스터 정보
   종목명: 삼성전자
   현재가: 71500
   상장주식수: 5969782550

📊 2. 주식기본정보 (opt10001)
      ✅ 데이터 수신: 주식기본정보

📊 3. 호가잔량 (opt10004)
      ✅ 데이터 수신: 호가잔량

📊 4. 일봉차트 (opt10081)
      기준일: 20250103 (가까운 금요일)
      ✅ 데이터 수신: 일봉차트
         일봉 데이터 10개

... (계속)
```

### 4. 저장 완료
```
✅ 수집 완료: 20가지
   💾 저장: stock_20types_005930_20250108_123456.json

====================================================================================
  전체 결과
====================================================================================
   005930 (삼성전자): 20가지
   000660 (SK하이닉스): 20가지
   035420 (NAVER): 20가지

   💾 저장: summary_20types_20250108_123456.json

✅ 완료!

5초 후 종료...
```

---

## 📁 결과 파일 확인

### 저장 위치
```bash
tests/stock_20types_005930_YYYYMMDD_HHMMSS.json
tests/stock_20types_000660_YYYYMMDD_HHMMSS.json
tests/stock_20types_035420_YYYYMMDD_HHMMSS.json
tests/summary_20types_YYYYMMDD_HHMMSS.json
```

### 결과 파일 구조 예시
```json
{
  "stock_code": "005930",
  "stock_name": "삼성전자",
  "timestamp": "2025-01-08T12:34:56",
  "data": {
    "01_마스터": {
      "종목명": "삼성전자",
      "현재가": "71500",
      "상장주식수": "5969782550"
    },
    "02_주식기본정보": {
      "trcode": "opt10001",
      "data": {
        "종목명": "삼성전자",
        "현재가": "71500",
        "등락률": "+1.42",
        "거래량": "12345678",
        "시가": "70500",
        "고가": "72000",
        "저가": "70000",
        ...
      }
    },
    "04_일봉차트": {
      "trcode": "opt10081",
      "data": {
        "items": [
          {
            "일자": "20250103",
            "현재가": "71500",
            "시가": "70500",
            "고가": "72000",
            "저가": "70000",
            "거래량": "12345678"
          },
          ...
        ],
        "count": 10
      }
    },
    ...
  }
}
```

---

## ⚠️ 문제 해결

### 문제 1: ModuleNotFoundError: No module named 'kiwoom'
**원인:** base 환경에서 실행
**해결:** `conda activate kiwoom32` 먼저 실행

### 문제 2: 로그인 창이 안 뜸
**원인:** Qt 환경 문제
**해결:** Windows 환경에서 실행 (Linux/WSL 불가)

### 문제 3: "응답 없음" 메시지
**원인:** API 호출 제한 또는 장 마감 시간
**해결:**
- 0.3초 대기는 이미 구현됨
- 주말/야간에는 일부 데이터 없을 수 있음

### 문제 4: Ctrl+C로 종료 안됨
**원인:** Qt 이벤트 루프 실행 중
**해결:** 5초 자동 종료 대기 또는 작업 관리자에서 종료

---

## 🔍 데이터 검증

### 결과 파일 확인
```bash
# tests/ 폴더로 이동
cd tests

# 최근 생성된 JSON 파일 확인
ls -lt *.json | head

# 파일 내용 미리보기
python -m json.tool stock_20types_005930_*.json | head -50
```

### Python으로 확인
```python
import json
from pathlib import Path

# 최근 파일 찾기
files = sorted(Path('tests').glob('stock_20types_*.json'))
latest = files[-1]

# 내용 확인
with open(latest, 'r', encoding='utf-8') as f:
    data = json.load(f)

print(f"종목: {data['stock_name']}")
print(f"수집 시각: {data['timestamp']}")
print(f"데이터 종류: {len(data['data'])}가지")

# 각 데이터 확인
for key, value in data['data'].items():
    if isinstance(value, dict):
        if 'trcode' in value:
            print(f"\n{key}: {value['trcode']}")
            if 'items' in value.get('data', {}):
                print(f"  항목 수: {len(value['data']['items'])}개")
        else:
            print(f"\n{key}: {value}")
```

---

## 📊 예상 결과

### 성공 시
- ✅ 로그인 성공
- ✅ 3개 종목 × 20가지 데이터 = 총 60개 데이터셋 수집
- ✅ JSON 파일 4개 생성 (종목별 3개 + 요약 1개)
- ✅ 자동 종료

### 일부 실패 시
- ⚠️ 일부 TR 코드에서 "응답 없음" 가능 (권한/시간 문제)
- ✅ 수집된 데이터만 저장됨
- 예: "20가지 중 15가지 수집됨"

---

## 🎯 다음 단계

1. **테스트 실행 확인**
   ```bash
   conda activate kiwoom32
   python test_stock_comprehensive_20.py
   ```

2. **결과 확인**
   ```bash
   ls -lh tests/*.json
   ```

3. **데이터 품질 검증**
   - 각 종목별로 데이터가 제대로 수집되었는지
   - 필드값이 비어있지 않은지
   - 날짜/시간 형식이 올바른지

4. **main.py 통합 준비**
   - 수집된 데이터 구조 파악
   - AI 분석에 필요한 필드 확인
   - 실시간 연동 설계
