# 키움 OpenAPI 연속 조회 제한 테스트

키움 OpenAPI의 정확한 TR 요청 제한을 파악하기 위한 체계적인 테스트 도구입니다.

## 문제 상황

현재 분봉 데이터 연속 조회 시 다음과 같은 문제가 발생:

```
1회차: 100개 수신 ✅
API 제한 준수를 위해 3초 대기...
2회차 요청 실패: 조회제한 초과 (TR 요청 제한) ❌
```

**목표**: 정확한 대기 시간과 최대 연속 조회 횟수를 찾아내기

## 테스트 내용

### 1. 대기 시간 테스트
다양한 대기 시간으로 2회 연속 조회 테스트:
- 1초, 3초, 5초, 10초, 15초, 20초, 30초

### 2. 연속 횟수 테스트
성공한 대기 시간으로 더 많은 횟수 테스트:
- 3회, 5회, 7회, 10회 연속 조회

### 3. 점진적 대기 테스트
각 요청마다 대기 시간을 늘려가며 테스트:
- 1회차 → 5초 대기 → 2회차 → 10초 대기 → 3회차 → 15초 대기 ...

## 사용 방법

### 방법 1: 배치 파일 실행 (권장)

```batch
run_api_rate_limit_test.bat
```

### 방법 2: 직접 실행

```batch
C:\Users\USER\anaconda3\envs\kiwoom32\python.exe test_api_rate_limits.py
```

## 실행 시 주의사항

1. **소요 시간**: 약 10-15분 소요
2. **키움 로그인**: 시작 시 로그인 창이 뜨면 로그인 필요
3. **테스트 간 대기**: 각 테스트 사이에 30초씩 대기
4. **장 시간 vs 장 마감 후**: 시간대에 따라 결과가 다를 수 있음
   - 장중: 더 엄격한 제한
   - 장 마감 후: 더 완화된 제한 가능

## 결과 파일

### 1. JSON 파일 (상세 데이터)
```
api_rate_limit_test_20251110_190000.json
```

모든 테스트 결과를 JSON 형식으로 저장:
- 각 시도별 성공/실패
- 수신 데이터 개수
- 오류 메시지
- 소요 시간

### 2. 리포트 파일 (요약)
```
api_rate_limit_report_20251110_190000.txt
```

읽기 쉬운 형식으로 요약:
- 테스트별 결과
- 성공/실패 통계
- 권장 설정값

## 예상 결과 분석

### Case 1: 특정 대기 시간에서 성공

```
✅ 2회 연속 성공 최소 대기 시간: 15초
📊 통계:
  - 최대 연속 성공: 5회
  - 최대 수집 데이터: 500개

💡 권장사항:
  - 대기 시간: 15초 이상
  - 최대 시도: 5회 이하
  - 예상 수집량: 500개
```

### Case 2: 모든 테스트 실패

```
❌ 2회 연속 성공한 조건 없음

💡 권장사항:
  - 연속 조회가 현재 시점에서 불가능할 수 있습니다
  - 장 마감 후 시간대에 다시 테스트 권장
  - 또는 단일 조회(100개)만 사용 권장
```

## 테스트 결과 활용

테스트에서 찾은 최적값을 `openapi_server_v2.py`에 적용:

```python
# 테스트 결과: 15초 대기, 최대 5회 성공
max_requests = 5
time.sleep(15.0)
timeout = 90  # 5회 × (10초 + 15초) = 125초, 안전하게 90초
```

## 트러블슈팅

### Q1: "사용자정보교환 실패" 오류
**A**: 키움 로그인이 안 된 상태입니다. 로그인 창을 찾아서 로그인하세요.

### Q2: 모든 테스트가 1회만 성공
**A**: 키움 API 제한이 매우 엄격한 시간대입니다:
- 오후 장 마감 후 (15:30 이후) 테스트 권장
- 또는 주말/공휴일에 테스트

### Q3: 테스트 중간에 중단하고 싶을 때
**A**: `Ctrl+C`를 누르면 현재까지의 결과가 저장됩니다.

## 키움 API 오류 코드

테스트 중 발생할 수 있는 오류:

- `-100`: 사용자정보교환 실패
- `-101`: 서버접속 실패
- `-102`: 버전처리 실패
- `-200`: 시세과부하
- `-201`: 조회전문작성 실패
- `-300`: **조회제한 초과 (TR 요청 제한)** ← 주요 오류

## 테스트 로그 예시

```
[19:00:01] 테스트: 대기시간 테스트 (5초)
[19:00:01] 조건: 대기시간=5초, 최대시도=2회

[19:00:01] --- 1회차 시도 (prev_next=0) ---
[19:00:02] ✅ 성공: 100개 수신 (누적: 100개)
[19:00:02]    Next prev_next: 2
[19:00:02] ⏳ 5초 대기 중...

[19:00:07] --- 2회차 시도 (prev_next=2) ---
[19:00:08] ✅ 성공: 100개 수신 (누적: 200개)
[19:00:08]    Next prev_next: 2

[19:00:08] 결과: ✅ 모든 시도 성공 (200개) - 최적 조건!
```

## 개선 아이디어

만약 테스트 결과가 만족스럽지 않다면:

1. **시간대 변경**: 장 마감 후나 주말에 테스트
2. **다른 종목**: 거래량이 적은 종목으로 테스트
3. **다른 TR**: opt10081 (일봉)로 테스트하여 분봉 제한과 비교
4. **대기 시간 더 늘리기**: 30초 → 60초 → 120초 테스트

## 참고

키움증권 OpenAPI 개발 가이드:
https://download.kiwoom.com/web/openapi/kiwoom_openapi_plus_devguide_ver_1.1.pdf
