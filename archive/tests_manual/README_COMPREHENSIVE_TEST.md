# 종합 데이터 수집 및 WebSocket 연결 테스트 가이드

## 📋 목적

이 테스트는 **스코어링 데이터 수집**과 **WebSocket 연결 조건**을 찾기 위해 다양한 API 조합을 테스트합니다.

### 테스트 내용

1. **Part 1: 스코어링 데이터 수집 API 테스트** (20가지 케이스)
   - 주식호가 (ka10004) - 3가지 조합
   - 주식체결정보 (ka10003) - 2가지 조합
   - 투자자별 매매 (ka10059) - 4가지 조합
   - 외국인 종목별 매매동향 (ka10008) - 2가지 조합
   - 주식기관 정보 (ka10009) - 1가지
   - 기관외국인 연속매매 (ka10131) - 4가지 조합
   - 장중 투자자별매매 (ka10063) - 1가지
   - 장마감후 투자자별매매 (ka10066) - 1가지
   - 종목별 기관매매추이 (ka10045) - 1가지
   - 증권사별 종목매매동향 (ka10078) - 1가지

2. **Part 2: WebSocket 연결 조건 테스트** (15가지 케이스)
   - 주문체결 구독 (00) - 2가지 조합
   - 주식체결 구독 (0B) - 2가지 조합
   - 주식호가잔량 구독 (0D) - 1가지
   - 복수 항목/종목 구독 - 2가지 조합
   - 잔고 구독 (04) - 1가지
   - 주식기세 구독 (0A) - 1가지
   - 주식우선호가 구독 (0C) - 1가지
   - grp_no 다양한 값 테스트 - 2가지 조합
   - data 배열 복수 항목 - 1가지

---

## 🚀 실행 방법

### 1. 필수 조건

- Python 3.8 이상
- 키움증권 REST API 인증 완료 (config.json에 토큰 설정)
- 필요한 패키지 설치:
  ```bash
  pip install websockets
  ```

### 2. 테스트 실행

```bash
# 프로젝트 루트에서 실행
python tests/manual_tests/test_comprehensive_data_collection.py
```

### 3. 실행 시간

- 예상 소요 시간: **약 3-5분**
- 스코어링 API 테스트: 약 1-2분
- WebSocket 테스트: 약 2-3분 (각 케이스당 5-10초)

---

## 📊 테스트 결과

### 자동 생성 파일

테스트 완료 후 다음 파일이 자동으로 생성됩니다:

```
tests/manual_tests/test_results_YYYYMMDD_HHMMSS.json
```

### 결과 파일 구조

```json
{
  "timestamp": "20241103_180000",
  "scoring_apis": [
    {
      "test_name": "Case 1-1: 주식호가 기본 조회 (KRX)",
      "api_id": "ka10004",
      "body": {"stk_cd": "005930"},
      "path": "mrkcond",
      "success": true,
      "return_code": 0,
      "return_msg": "정상적으로 처리되었습니다",
      "has_data": true,
      "data_keys": ["bid_req_base_tm", "sel_fpr_bid", "buy_fpr_bid", ...],
      "sample_data": { ... }
    },
    ...
  ],
  "websocket_tests": [
    {
      "test_name": "WS Case 1-1: 주문체결 구독 (type=00, refresh=1)",
      "subscribe_request": {
        "trnm": "REG",
        "grp_no": "1",
        "refresh": "1",
        "data": [{"item": [""], "type": ["00"]}]
      },
      "success": true,
      "connected": true,
      "subscription_success": true,
      "messages_received": 5,
      "sample_messages": [ ... ]
    },
    ...
  ]
}
```

---

## 🔍 결과 분석

### 화면 출력

테스트 실행 중 실시간으로 다음 정보가 출력됩니다:

1. **진행 상황**
   ```
   🧪 테스트: Case 1-1: 주식호가 기본 조회 (KRX)
      API: ka10004
      Body: {"stk_cd": "005930"}
      ✅ 성공: 정상적으로 처리되었습니다
      📊 데이터 키: ['bid_req_base_tm', 'sel_fpr_bid', 'buy_fpr_bid', ...]
      📦 샘플 데이터 (첫 번째):
         {...}
   ```

2. **최종 요약**
   ```
   📊 스코어링 API - 성공한 케이스:
     ✅ Case 1-1: 주식호가 기본 조회 (KRX)
        API: ka10004
        데이터 키: ['bid_req_base_tm', 'sel_fpr_bid', ...]

   🎯 스코어링을 위한 추천 API 조합:
     📌 ka10004:
        - Case 1-1: 주식호가 기본 조회 (KRX)
          Body: {"stk_cd": "005930"}

   📡 WebSocket - 성공한 케이스:
     ✅ WS Case 1-1: 주문체결 구독 (type=00, refresh=1)
        구독 요청: {"trnm": "REG", "grp_no": "1", ...}
        수신 메시지: 5개
   ```

### 성공 기준

#### 스코어링 API
- ✅ **완전 성공**: `return_code == 0` + 데이터 존재
- ⚠️ **부분 성공**: `return_code == 0` + 데이터 없음 (장외시간 가능성)
- ❌ **실패**: `return_code != 0` 또는 예외 발생

#### WebSocket
- ✅ **완전 성공**: 연결 성공 + 구독 성공 + 메시지 수신
- ⚠️ **부분 성공**: 연결 성공 + 구독 성공 + 메시지 없음
- ⚠️ **부분 성공**: 연결 성공만
- ❌ **실패**: 연결 실패

---

## 📖 테스트 케이스 상세 설명

### Part 1: 스코어링 API 테스트

#### Case 1: 주식호가 (ka10004)
**목적**: 매도/매수 호가, 잔량 정보 수집

| 케이스 | 종목코드 | 설명 |
|--------|---------|------|
| 1-1 | 005930 | KRX 거래소 기본 조회 |
| 1-2 | 005930_NX | NXT 거래소 (시간외) |
| 1-3 | 005930_AL | SOR 거래소 (통합) |

**예상 데이터 키**:
- `sel_fpr_bid`: 매도최우선호가
- `buy_fpr_bid`: 매수최우선호가
- `tot_sel_req`: 총매도잔량
- `tot_buy_req`: 총매수잔량

---

#### Case 2: 주식체결정보 (ka10003)
**목적**: 현재가, 거래량, 등락률 수집

| 케이스 | 종목코드 | 설명 |
|--------|---------|------|
| 2-1 | 005930 | KRX 기본 조회 |
| 2-2 | 005930_NX | NXT 거래소 |

**예상 데이터 키**:
- `cur_prc`: 현재가
- `cntr_trde_qty`: 체결거래량
- `acc_trde_qty`: 누적거래량

---

#### Case 3: 투자자별 매매 (ka10059)
**목적**: 기관/외국인/개인 순매수 데이터 수집

| 케이스 | amt_qty_tp | trde_tp | 설명 |
|--------|-----------|---------|------|
| 3-1 | 1 (금액) | 0 (순매수) | 금액 기준 순매수 |
| 3-2 | 2 (수량) | 0 (순매수) | 수량 기준 순매수 |
| 3-3 | 2 (수량) | 1 (매수) | 수량 기준 매수량 |
| 3-4 | 2 (수량) | 2 (매도) | 수량 기준 매도량 |

**예상 데이터 키**:
- `orgn`: 기관 순매수
- `frgnr_invsr`: 외국인 순매수
- `ind_invsr`: 개인 순매수

---

#### Case 4: 외국인 종목별 매매동향 (ka10008)
**목적**: 외국인 매매 동향 상세 분석

| 케이스 | 종목코드 | 설명 |
|--------|---------|------|
| 4-1 | 005930 | KRX 기본 조회 |
| 4-2 | 005930_NX | NXT 거래소 |

**예상 데이터 키**:
- `stk_frgnr`: 외국인 매매 리스트
- `trde_qty`: 거래량
- `chg_qty`: 변동수량
- `poss_stkcnt`: 보유주식수

---

#### Case 5: 주식기관 정보 (ka10009)
**목적**: 기관 매매 정보 수집

**예상 데이터 키**:
- `orgn_dt_acc`: 기관기간누적
- `orgn_daly_nettrde`: 기관일별순매매
- `frgnr_daly_nettrde`: 외국인일별순매매

---

#### Case 6: 기관외국인 연속매매 (ka10131)
**목적**: 기관/외국인 연속 순매수 패턴 분석

| 케이스 | dt | stex_tp | amt_qty_tp | 설명 |
|--------|----|---------|-----------|----- |
| 6-1 | 1 (최근일) | 1 (KRX) | 0 (금액) | 최근 1일 금액 기준 |
| 6-2 | 5 (5일) | 1 (KRX) | 1 (수량) | 최근 5일 수량 기준 |
| 6-3 | 1 | 2 (NXT) | 0 | NXT 거래소 |
| 6-4 | 1 | 3 (통합) | 0 | 통합 거래소 |

**예상 데이터 키**:
- `orgn_frgnr_cont_trde_prst`: 연속매매현황 리스트
- `orgn_nettrde_amt`: 기관순매매금액
- `frgnr_nettrde_amt`: 외국인순매매액
- `orgn_cont_netprps_dys`: 기관계연속순매수일수

---

### Part 2: WebSocket 테스트

#### WS Case 1: 주문체결 구독 (type=00)
**목적**: 계좌 주문/체결 실시간 수신

| 케이스 | refresh | 설명 |
|--------|---------|------|
| 1-1 | 1 | 기존 구독 유지 |
| 1-2 | 0 | 기존 구독 해지 |

**예상 응답**:
```json
{
  "trnm": "REG",
  "return_code": 0,
  "return_msg": ""
}
```

**실시간 데이터**:
```json
{
  "trnm": "REAL",
  "data": [{
    "type": "00",
    "name": "주문체결",
    "values": {
      "9201": "계좌번호",
      "9203": "주문번호",
      "9001": "종목코드",
      "913": "주문상태",
      ...
    }
  }]
}
```

---

#### WS Case 2: 주식체결 구독 (type=0B)
**목적**: 특정 종목 체결 실시간 수신

| 케이스 | item | 설명 |
|--------|------|------|
| 2-1 | ["005930"] | 삼성전자 지정 |
| 2-2 | [""] | 빈 item (전체?) |

**실시간 데이터**:
```json
{
  "trnm": "REAL",
  "data": [{
    "type": "0B",
    "name": "주식체결",
    "item": "005930",
    "values": {
      "10": "현재가",
      "11": "전일대비",
      "12": "등락률",
      ...
    }
  }]
}
```

---

#### WS Case 3: 주식호가잔량 구독 (type=0D)
**목적**: 호가 변동 실시간 수신

**실시간 데이터**:
```json
{
  "trnm": "REAL",
  "data": [{
    "type": "0D",
    "name": "주식호가잔량",
    "item": "005930",
    "values": {
      "27": "매도최우선호가",
      "28": "매수최우선호가",
      ...
    }
  }]
}
```

---

#### WS Case 4-9: 다양한 조합 테스트
- **Case 4**: 복수 type/item 구독
- **Case 5**: 잔고 구독 (type=04)
- **Case 6**: 주식기세 구독 (type=0A)
- **Case 7**: 주식우선호가 구독 (type=0C)
- **Case 8**: grp_no 다양한 값 테스트
- **Case 9**: data 배열 복수 항목

---

## 🎯 활용 방법

### 1. 스코어링 API 선택

테스트 결과에서 **성공한 케이스**를 확인하고, 필요한 데이터를 제공하는 API를 선택합니다.

예시:
```python
# 호가 정보 수집
response = client.request(
    api_id='ka10004',
    body={'stk_cd': '005930'},
    path='mrkcond'
)

# 투자자별 매매 수집
response = client.request(
    api_id='ka10059',
    body={
        'stk_cd': '005930',
        'dt': '20241103',
        'amt_qty_tp': '1',
        'trde_tp': '0',
        'unit_tp': '1000'
    },
    path='stkinfo'
)
```

### 2. WebSocket 구독 설정

테스트 결과에서 **성공한 구독 요청**을 복사하여 사용합니다.

예시:
```python
subscribe_request = {
    "trnm": "REG",
    "grp_no": "1",
    "refresh": "1",
    "data": [{
        "item": ["005930"],
        "type": ["0B"]
    }]
}

await websocket.send(json.dumps(subscribe_request))
```

### 3. 실패 케이스 디버깅

**부분 성공** 또는 **실패** 케이스는 다음을 확인:
- 모의투자 vs 실제 서버 (일부 API는 실제 서버만 지원)
- 장중 vs 장외 시간 (일부 데이터는 장중에만 제공)
- 파라미터 값 범위 (문서에서 허용된 값 확인)

---

## 📚 참고 문서

- **키움 API 문서**: `kiwoom_docs/` 폴더
  - `시세.md`: 시세 API 상세 설명
  - `기관-외국인.md`: 기관/외국인 API 상세 설명
  - `실시간시세.md`: WebSocket API 상세 설명

---

## ⚠️ 주의사항

1. **API 호출 제한**
   - 키움증권 API는 초당 요청 제한이 있을 수 있습니다
   - 테스트는 순차적으로 실행되므로 안전합니다

2. **장외 시간**
   - 일부 API는 장중에만 데이터를 제공합니다
   - 장외 시간에는 `has_data: false`가 정상입니다

3. **WebSocket 안정성**
   - 키움 서버는 주기적으로 "Bye" 메시지를 보내 연결을 종료할 수 있습니다
   - 재접속 로직이 필요합니다

4. **실제 매매**
   - 이 테스트는 조회만 수행하며, 실제 주문은 발생하지 않습니다

---

## 🐛 문제 해결

### Q1: "No module named 'websockets'" 오류

```bash
pip install websockets
```

### Q2: "인증 실패" 오류

`config.json`에 유효한 `access_token`이 설정되어 있는지 확인:
```json
{
  "access_token": "eyJhbG...",
  "base_url": "https://api.kiwoom.com"
}
```

### Q3: WebSocket 테스트가 모두 실패

- 모의투자 서버에서는 WebSocket이 제한적일 수 있습니다
- 실제 운영 서버에서 테스트해보세요

### Q4: 스코어링 API에서 데이터가 없음

- 장외 시간에는 일부 API가 데이터를 제공하지 않습니다
- 장중 시간 (09:00-15:30)에 다시 테스트해보세요

---

## 📞 지원

문제가 지속되면 다음 정보와 함께 문의:
- 테스트 결과 JSON 파일
- 실행 로그
- 실행 시간대 (장중/장외)
- 서버 타입 (모의투자/운영)

---

**Happy Testing! 🚀**
