# NXT 시간외 거래 및 WebSocket 테스트

## 📋 개요

이 폴더는 **NXT 시간외 거래**와 **WebSocket 연결**을 다양한 조합으로 테스트하는 스크립트를 포함합니다.

⚠️ **중요**: 이 테스트들은 **실제 주문을 체결**합니다. 소액(1주)으로 테스트하며, 주문 후 즉시 취소합니다.

---

## 🧪 테스트 파일

### 1. **test_nxt_trading_combinations.py**
**NXT 시간외 거래 매수/매도 조합 테스트**

#### 🎯 목적
- 다양한 거래 파라미터 조합을 시도해서 **정답을 찾습니다**
- 12가지 조합을 자동으로 테스트
- 성공한 조합을 보고서로 출력

#### 📊 테스트 조합

| # | dmst_stex_tp | trde_tp | ord_uv | 설명 |
|---|--------------|---------|---------|------|
| 1 | NXT | 62 | "" | 시간외 단일가 (가장 가능성 높음) |
| 2 | NXT | 62 | 가격 | 시간외 단일가 + 가격 지정 |
| 3 | KRX | 62 | "" | KRX + 시간외 단일가 |
| 4 | NXT | 81 | "" | 장마감후 시간외 종가 |
| 5 | KRX | 81 | "" | KRX + 장마감후 시간외 |
| 6 | NXT | 61 | "" | 장시작전 시간외 |
| 7 | KRX | 61 | "" | KRX + 장시작전 시간외 |
| 8 | KRX | 0 | 가격 | 정규장 보통 지정가 |
| 9 | KRX | 3 | "" | 정규장 시장가 |
| 10 | SOR | 62 | "" | SOR + 시간외 단일가 |
| 11 | NXT | 0 | 가격 | NXT + 보통 지정가 (잘못된 조합) |
| 12 | ... | ... | ... | 기타 조합들 |

#### 🚀 실행 방법

```bash
# 테스트 디렉토리로 이동
cd tests/manual_tests

# 테스트 실행
python test_nxt_trading_combinations.py
```

#### 📈 출력 예시

```
================================================================================
📊 테스트 결과 요약
================================================================================

총 12개 케이스 테스트
성공: 3개 ✅
실패: 9개 ❌

================================================================================
✅ 성공한 조합:
================================================================================
  🎯 NXT + 시간외단일가(62) + 빈가격
     dmst_stex_tp=NXT, trde_tp=62, ord_uv=
     주문번호: 00024

  🎯 NXT + 장마감후시간외(81) + 빈가격
     dmst_stex_tp=NXT, trde_tp=81, ord_uv=
     주문번호: 00025

================================================================================
💡 결론
================================================================================
✅ 성공한 조합을 사용하세요!
   권장 설정: dmst_stex_tp=NXT, trde_tp=62, ord_uv=
```

---

### 2. **test_websocket_connection.py**
**WebSocket 연결 상태 종합 테스트**

#### 🎯 목적
- WebSocket 연결의 다양한 시나리오 테스트
- 안정성 및 재연결 확인
- 실시간 데이터 수신 확인

#### 📊 테스트 케이스

| # | 테스트 | 설명 | 소요 시간 |
|---|--------|------|-----------|
| 1 | 기본 연결 | 구독 없이 기본 연결만 테스트 | 10초 |
| 2 | 체결 정보 구독 | 삼성전자 체결 정보 구독 및 메시지 수신 | 30초 |
| 3 | 재연결 테스트 | 연결 → 종료 → 재연결 | 10초 |
| 4 | 장시간 안정성 | 60초 동안 연결 유지 확인 | 60초 |
| 5 | 다중 구독 | 5개 종목 동시 구독 | 20초 |

#### 🚀 실행 방법

```bash
# 테스트 디렉토리로 이동
cd tests/manual_tests

# 테스트 실행
python test_websocket_connection.py
```

#### 📈 출력 예시

```
================================================================================
📊 WebSocket 테스트 결과 요약
================================================================================

총 5개 테스트 실행
성공: 4개 ✅
실패: 1개 ❌

상세 결과:
================================================================================

  ✅ 성공 - 기본 연결 (구독 없음)
    💡 구독 없이 기본 연결만 테스트

  ✅ 성공 - 체결 정보 구독
    💡 45개 메시지 수신

  ✅ 성공 - 재연결 테스트
    💡 재연결 성공

  ❌ 실패 - 장시간 연결 안정성
    ⚠️  오류: 3회 연결 끊김

  ✅ 성공 - 다중 종목 구독
    💡 5개 종목 구독, 128개 메시지

================================================================================
💡 결론
================================================================================
⚠️  일부 테스트만 통과했습니다.
   실패한 테스트를 확인하고 문제를 해결하세요.
```

---

## ⏰ 테스트 시간대

### 매수/매도 테스트

테스트를 실행할 적절한 시간대:

| 시간대 | 설명 | 권장 여부 |
|--------|------|-----------|
| **16:00-20:00** | 시간외 단일가 거래 시간 | ✅ **강력 권장** |
| **15:40-16:00** | 장마감후 시간외 종가 거래 | ✅ 권장 |
| **08:00-09:00** | 장시작전 시간외 거래 | ✅ 권장 |
| **09:00-15:30** | 정규장 거래 | ⚠️ 정규장 테스트 시 |
| **20:00-08:00** | 거래 불가 시간 | ❌ 모두 실패 |

### WebSocket 테스트

- **언제든지 가능** (24시간)
- 단, 정규장 시간대(09:00-15:30)에 실행하면 실시간 데이터가 더 많이 수신됩니다

---

## ⚙️ 전제 조건

### 1. **환경 설정**

```bash
# 의존성 설치
pip install -r requirements.txt

# 설정 파일 확인
config/settings.yaml
```

### 2. **키움 API 인증**

- `config/settings.yaml`에 키움 API 키 설정
- 실제 운영 서버 사용: `https://api.kiwoom.com`
- 모의투자 서버: `https://mockapi.kiwoom.com` (NXT 불가)

### 3. **계좌 정보**

- 실제 거래 가능한 계좌 필요
- 1주 매수 가능한 잔고 필요 (약 10-15만원)

---

## 🔍 트러블슈팅

### 문제 1: "주문이 불가능한 주문종류입니다"

**원인:**
- 모의투자 서버 사용 중 (NXT 지원 안 함)
- 잘못된 거래유형 조합

**해결:**
1. 서버 URL 확인:
   ```python
   # core/rest_client.py 로그 확인
   ✅ 실제 운영 서버 사용 중: https://api.kiwoom.com
   ```

2. 테스트 실행해서 정답 찾기:
   ```bash
   python test_nxt_trading_combinations.py
   ```

### 문제 2: WebSocket 연결 끊김

**원인:**
- 키움 서버가 주기적으로 "Bye" 메시지 전송
- 구독 없이 idle 상태

**해결:**
1. WebSocket 테스트 실행:
   ```bash
   python test_websocket_connection.py
   ```

2. 구독 추가 (체결, 호가 등)

3. 또는 WebSocket 비활성화:
   ```python
   # main.py
   self.websocket_client = None
   ```

### 문제 3: 시간외 주문 실패

**원인:**
- 거래 시간대가 아님
- ord_uv(가격) 잘못 지정

**해결:**
1. 현재 시간 확인:
   ```bash
   # 16:00-20:00 권장
   date
   ```

2. ord_uv를 빈 문자열로:
   ```python
   "ord_uv": ""  # 시간외 거래는 단일가이므로 가격 지정 안 함
   ```

---

## 📝 테스트 결과 활용

### 성공한 조합 적용

테스트에서 성공한 조합을 `main.py`에 적용:

```python
# main.py의 _test_samsung_trade() 함수에서
if 16 <= current_hour < 20:
    market_type = "시간외 단일가"
    order_type = "62"  # 테스트에서 찾은 정답

    # buy() 호출 시
    buy_result = self.order_api.buy(
        stock_code=samsung_code,
        quantity=1,
        price=current_price,  # 실제로는 무시됨
        order_type=order_type  # "62"
    )
```

### WebSocket 연결 문제 해결

1. **안정적으로 작동하는 경우:**
   - WebSocket 활성화 유지
   - 실시간 데이터 활용

2. **계속 끊기는 경우:**
   - WebSocket 비활성화
   - REST API만 사용
   ```python
   self.websocket_client = None
   ```

---

## 🎯 다음 단계

1. **테스트 실행:**
   ```bash
   # 매수/매도 조합 테스트
   python test_nxt_trading_combinations.py

   # WebSocket 테스트
   python test_websocket_connection.py
   ```

2. **결과 분석:**
   - 성공한 조합 파악
   - 실패 원인 확인

3. **코드 적용:**
   - `main.py`에 성공한 조합 적용
   - WebSocket 설정 조정

4. **실제 운영:**
   - 프로그램 재시작
   - 실제 거래 확인

---

## 📞 지원

문제가 발생하면:
1. 로그 확인 (`logs/` 디렉토리)
2. 테스트 결과 요약 확인
3. 서버 URL 확인 (mockapi vs api.kiwoom.com)
4. 거래 시간대 확인

---

## ⚠️ 주의사항

1. **실제 주문 체결**: 테스트 시 실제 주문이 체결됩니다.
2. **소액 테스트**: 1주씩만 주문하며 즉시 취소합니다.
3. **시간대 확인**: 적절한 거래 시간대에 테스트하세요.
4. **서버 확인**: 실제 운영 서버(api.kiwoom.com) 사용 확인
5. **계좌 잔고**: 충분한 잔고가 있는지 확인하세요.

---

**좋은 테스트 되시길 바랍니다! 🚀**
