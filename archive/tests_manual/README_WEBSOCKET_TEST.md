# WebSocket μ „μ© ν…μ¤νΈ

WebSocket κµ¬λ… μ΅°κ±΄μ„ λ‹¤μ–‘ν•κ² ν…μ¤νΈν•μ—¬ μ •λ‹µμ„ μ°Ύλ” ν…μ¤νΈ λ„κµ¬μ…λ‹λ‹¤.

## μ‹¤ν–‰ λ°©λ²•

```bash
cd /home/user/autotrade
python tests/manual_tests/test_websocket_only.py
```

## ν…μ¤νΈ μΉ΄ν…κ³ λ¦¬

### π“¦ μΉ΄ν…κ³ λ¦¬ 1: μ£Όλ¬Έ/μ²΄κ²° κµ¬λ…
- **Case 1-1**: μ£Όλ¬Έμ²΄κ²° κµ¬λ… (type=00)
- **Case 1-2**: μ”κ³  κµ¬λ… (type=04)

### π“¦ μΉ΄ν…κ³ λ¦¬ 2: μ‹¤μ‹κ°„ μ‹μ„Έ (λ‹¨μΌ μΆ…λ©)
- **Case 2-1**: μ£Όμ‹μ²΄κ²° (type=0B) - μ‚Όμ„±μ „μ
- **Case 2-2**: μ£Όμ‹νΈκ°€μ”λ‰ (type=0D) - μ‚Όμ„±μ „μ
- **Case 2-3**: μ£Όμ‹κΈ°μ„Έ (type=0A) - μ‚Όμ„±μ „μ
- **Case 2-4**: μ£Όμ‹μ°μ„ νΈκ°€ (type=0C) - μ‚Όμ„±μ „μ

### π“¦ μΉ΄ν…κ³ λ¦¬ 3: λ³µμ ν•­λ© κµ¬λ…
- **Case 3-1**: μ²΄κ²°+νΈκ°€ λ™μ‹ κµ¬λ… (type λ°°μ—΄)
  ```json
  {
    "data": [{
      "item": ["005930"],
      "type": ["0B", "0D"]
    }]
  }
  ```

- **Case 3-2**: μ²΄κ²°+νΈκ°€ λ™μ‹ κµ¬λ… (data λ°°μ—΄ λ¶„λ¦¬)
  ```json
  {
    "data": [
      {"item": ["005930"], "type": ["0B"]},
      {"item": ["005930"], "type": ["0D"]}
    ]
  }
  ```

- **Case 3-3**: λ³µμ μΆ…λ© κµ¬λ… (μ‚Όμ„±μ „μ+SKν•μ΄λ‹‰μ¤)
  ```json
  {
    "data": [{
      "item": ["005930", "000660"],
      "type": ["0B"]
    }]
  }
  ```

### π“¦ μΉ΄ν…κ³ λ¦¬ 4: refresh νλΌλ―Έν„°
- **Case 4-1**: refresh=0 (κ°±μ‹  μ• ν•¨)
- **Case 4-2**: refresh=1 (κ°±μ‹  ν•¨)

### π“¦ μΉ΄ν…κ³ λ¦¬ 5: grp_no νλΌλ―Έν„°
λ‹¤μ–‘ν• grp_no κ°’ ν…μ¤νΈ:
- grp_no=1, 2, 10, 99, 100, 1234

### π“¦ μΉ΄ν…κ³ λ¦¬ 6: item λΉ κ°’
- **Case 6-1**: item=λΉλ¬Έμμ—΄ `[""]`
- **Case 6-2**: item=λΉλ°°μ—΄ `[]`

## κ²°κ³Ό λ¶„μ„

### μ„±κ³µ μ΅°κ±΄
ν…μ¤νΈλ” λ‹¤μ μ΅°κ±΄ μ¤‘ ν•λ‚λ¥Ό λ§μ΅±ν•λ©΄ μ„±κ³µμΌλ΅ νμ •ν•©λ‹λ‹¤:
1. **μ—°κ²° μ„±κ³µ** AND **κµ¬λ… μ„±κ³µ (REG return_code=0)**
2. **μ—°κ²° μ„±κ³µ** AND **μ‹¤μ‹κ°„ λ©”μ‹μ§€ μμ‹  (REAL)**

### μ¶λ ¥ μ •λ³΄
κ° ν…μ¤νΈλ§λ‹¤ λ‹¤μμ„ μ¶λ ¥ν•©λ‹λ‹¤:
- β…/β μ—°κ²° μ„±κ³µ μ—¬λ¶€
- β…/β κµ¬λ… μ„±κ³µ μ—¬λ¶€ (REG μ‘λ‹µ)
- π“¨ μμ‹ λ λ©”μ‹μ§€ κ°μ
- π“© μ‘λ‹µ νƒ€μ… λ©λ΅ (REG, REAL λ“±)
- π’Ύ μƒν” λ©”μ‹μ§€ (μ²μ 5κ°)

### κ²°κ³Ό νμΌ
ν…μ¤νΈ μ™„λ£ ν›„ μλ™μΌλ΅ JSON νμΌ μ €μ¥:
```
tests/manual_tests/websocket_test_results_YYYYMMDD_HHMMSS.json
```

JSON νμΌ κµ¬μ΅°:
```json
{
  "websocket_tests": [
    {
      "test_name": "Case 2-1: μ£Όμ‹μ²΄κ²° (type=0B, μ‚Όμ„±μ „μ)",
      "subscribe_request": {...},
      "connected": true,
      "subscription_success": true,
      "messages_received": 15,
      "response_types": ["REG", "REAL"],
      "sample_messages": [...]
    }
  ],
  "summary": {
    "total": 20,
    "connected": 20,
    "subscription_success": 15,
    "success": 18,
    "received_messages": 250
  }
}
```

## λ¬Έμ  ν•΄κ²°

### WebSocket μ—°κ²° μ‹¤ν¨
```
β ν…μ¤νΈ μ‹¤ν¨: Connection refused
```
- λ„¤νΈμ›ν¬ μ—°κ²° ν™•μΈ
- API URL ν™•μΈ (mockapi vs api)
- ν† ν° μ ν¨μ„± ν™•μΈ

### κµ¬λ… μ‘λ‹µ μ—†μ
```
β οΈ  ν…μ¤νΈ λ¶€λ¶„ μ„±κ³µ
   μ—°κ²°: β…
   κµ¬λ…: β
   μμ‹ : 0κ°
```
κ°€λ¥ν• μ›μΈ:
1. μ¥ λ§κ° μ‹κ°„ (μ‹¤μ‹κ°„ λ°μ΄ν„° μ—†μ)
2. μλ»λ κµ¬λ… μ”μ²­ ν•μ‹
3. μΆ…λ©μ½”λ“ μ¤λ¥
4. κ¶ν• λ¶€μ΅±

### λ©”μ‹μ§€λ” μμ‹ λλ‚ κµ¬λ… μ‹¤ν¨λ΅ ν‘μ‹
```
   μ—°κ²°: β…
   κµ¬λ…: β
   μμ‹ : 10κ°
   μ‘λ‹µ νƒ€μ…: REAL
```
- REG μ‘λ‹µμ΄ μ—†κ±°λ‚ return_code != 0
- ν•μ§€λ§ REAL λ©”μ‹μ§€λ” μμ‹  μ¤‘
- **μ΄ κ²½μ°λ„ μ„±κ³µμΌλ΅ νμ •λ¨**

## μ£Όμ” μ°¨μ΄μ  (vs test_comprehensive_data_collection.py)

| ν•­λ© | μΆ…ν•© ν…μ¤νΈ | WebSocket μ „μ© |
|------|-------------|----------------|
| **ν…μ¤νΈ λ€μƒ** | REST API + WebSocket | WebSocketλ§ |
| **WebSocket μΌ€μ΄μ¤** | 13κ° | 20+κ° |
| **μΉ΄ν…κ³ λ¦¬ λ¶„λ¥** | μ—†μ | 6κ° μΉ΄ν…κ³ λ¦¬ |
| **νλΌλ―Έν„° ν…μ¤νΈ** | μ ν•μ  | grp_no 6κ°€μ§€, refresh 2κ°€μ§€ λ“± |
| **λ³µμ κµ¬λ…** | 3κ° | 5κ° (λ” λ‹¤μ–‘ν• ν¨ν„΄) |
| **μ¶λ ¥ ν•μ‹** | ν†µν•© | WebSocket μ „μ© μƒμ„Έ |
| **μ‹¤ν–‰ μ‹κ°„** | ~5λ¶„ | ~3λ¶„ |

## λ‹¤μ λ‹¨κ³„

1. **ν…μ¤νΈ μ‹¤ν–‰**
   ```bash
   python tests/manual_tests/test_websocket_only.py
   ```

2. **κ²°κ³Ό JSON ν™•μΈ**
   - μ„±κ³µν• μΌ€μ΄μ¤μ subscribe_request λ³µμ‚¬
   - main.pyμ— μ μ©

3. **μ„±κ³µ ν¨ν„΄ λ¶„μ„**
   - μ–΄λ–¤ grp_noκ°€ κ°€μ¥ μ•μ •μ μΈκ°€?
   - refresh=0 vs refresh=1 μ°¨μ΄?
   - λ³µμ κµ¬λ… μ‹ data λ°°μ—΄ vs type λ°°μ—΄?

4. **WebSocket λ§¤λ‹μ € κµ¬ν„**
   - μ„±κ³µν• ν¨ν„΄μ„ WebSocketManagerμ— μ μ©
   - μ‹¤μ‹κ°„ νΈκ°€/μ²΄κ²° μμ‹ 
   - main.py μλ™λ§¤λ§¤μ— ν†µν•©
