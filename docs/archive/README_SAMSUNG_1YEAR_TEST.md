# 삼성전자 1년 전 분봉 데이터 조회 테스트

## 📋 개요

64비트 Kiwoom Open API를 사용하여 **삼성전자(005930) 1년 전 분봉 데이터**를 조회하는 테스트 스크립트입니다.

### 주요 기능

- ✅ 64비트 Python 3.11.9 환경에서 Kiwoom Open API 작동
- ✅ 연속 조회를 통한 대량 데이터 수집
- ✅ 1분봉, 60분봉 데이터 수집
- ✅ CSV 파일로 자동 저장
- ✅ 1년 전 과거 데이터 조회 가능 여부 확인

## 🚀 사전 준비

### 1. Python 환경 확인

```bash
# Python 버전 및 아키텍처 확인
python --version
# Python 3.11.9

python -c "import struct; print(f'{struct.calcsize(\"P\") * 8}비트 Python')"
# 64비트 Python
```

**중요:** 반드시 **64비트 Python 3.11.9**를 사용해야 합니다!

### 2. 64비트 Kiwoom Open API 설치

GitHub 저장소: https://github.com/teranum/64bit-kiwoom-openapi

#### 설치 단계

1. **Visual C++ Redistributable (x64) 설치**
   - https://learn.microsoft.com/ko-kr/cpp/windows/latest-supported-vc-redist

2. **64비트 OpenAPI 파일 다운로드**
   ```bash
   git clone https://github.com/teranum/64bit-kiwoom-openapi.git
   cd 64bit-kiwoom-openapi
   ```

3. **파일을 C:\OpenAPI 폴더에 복사**
   - 국내: `C:\OpenApi`
   - 해외선물: `C:\OpenApiG`

4. **관리자 권한으로 OCX 등록**
   ```cmd
   # 명령 프롬프트를 관리자 권한으로 실행
   regsvr32 C:\OpenApi\KHOpenAPI64.ocx
   ```

   성공 시: "DllRegisterServer in C:\OpenApi\KHOpenAPI64.ocx succeeded." 메시지

### 3. Python 패키지 설치

```bash
pip install pywin32
```

### 4. 다른 Kiwoom 프로그램 종료

**중요:** 테스트 실행 전에 반드시 다음을 종료하세요:

- 키움증권 HTS (영웅문)
- 다른 Open API 기반 프로그램
- 작업 관리자에서 `KH`로 시작하는 모든 프로세스

## 📖 사용 방법

### 기본 실행

```bash
python test_samsung_1year_minute_data.py
```

### 실행 흐름

1. **환경 확인**
   - Python 버전 및 아키텍처 확인
   - pywin32 모듈 확인

2. **ActiveX 연결**
   - KHOPENAPI.KHOpenAPICtrl.1 컨트롤 생성

3. **로그인**
   - 로그인 창이 나타나면 **수동으로 로그인**
   - 공동인증서 또는 간편 인증 사용

4. **데이터 조회**
   - 테스트 1: 1분봉 1000개 조회 (약 2~3 거래일)
   - 테스트 2: 60분봉 1000개 조회 (약 2~3개월)

5. **결과 저장**
   - `samsung_1min_data.csv` - 1분봉 데이터
   - `samsung_60min_data.csv` - 60분봉 데이터

### 예상 출력

```
================================================================================
  🚀 삼성전자 1년 전 분봉 데이터 조회 테스트
================================================================================

🔌 64비트 Kiwoom Open API 연결 시도...

✅ ActiveX 컨트롤 생성 성공 (KHOPENAPI.KHOpenAPICtrl.1)

🔐 로그인 시도 중...
   로그인 창이 나타나면 ID/PW를 입력하세요...

✅ 로그인 요청 전송 완료
   ✅ [이벤트] 로그인 성공

✅ 로그인 성공!

📋 로그인 정보:
   사용자 ID: ********
   사용자명: ***
   보유 계좌수: 1
   계좌번호: **********

================================================================================
  📊 삼성전자(005930) 분봉 데이터 수집
================================================================================

🔍 테스트 1: 1분봉 1000개 조회 (약 2~3 거래일)
📊 분봉 데이터 연속 조회 시작
   종목코드: 005930 (삼성전자)
   틱범위: 1분
   목표 개수: 1000개
   예상 기간: 약 0.7일치 데이터

   [1차] 900 개 수신 (누적: 900개)
   [2차] 100 개 수신 (누적: 1000개)
   → 마지막 페이지 도달 (prev_next=0)

✅ 총 1000개 데이터 수신 완료
   기간: 20250105090000 ~ 20250107153000
```

## 📊 출력 데이터 형식

### CSV 파일 구조

| 컬럼명 | 설명 | 예시 |
|--------|------|------|
| date | 체결시간 (YYYYMMDDHHMMSS) | 20250107153000 |
| open | 시가 | 71500 |
| high | 고가 | 71700 |
| low | 저가 | 71500 |
| close | 종가 (현재가) | 71600 |
| volume | 거래량 | 12345 |

### 데이터 예시

```
일자         시각     현재가        시가        고가        저가      거래량
------------------------------------------------------------------------------------
20250107    153000      71,600      71,500      71,700      71,500      12,345
20250107    152900      71,500      71,600      71,650      71,500      23,456
...
```

## 🔧 커스터마이징

### 1. 다른 종목 조회

```python
# 테스트 파일 수정
data = kiwoom.request_minute_chart(
    stock_code="035720",  # 카카오
    interval=1,
    target_count=1000
)
```

### 2. 조회 개수 변경

```python
# 더 많은 데이터 조회 (최대 약 10000개)
data = kiwoom.request_minute_chart(
    stock_code="005930",
    interval=1,
    target_count=5000  # 5000개
)
```

### 3. 분봉 단위 변경

```python
# 5분봉 조회
data = kiwoom.request_minute_chart(
    stock_code="005930",
    interval=5,  # 1, 3, 5, 10, 15, 30, 45, 60분
    target_count=1000
)
```

## ⚠️ 주의사항

### API 호출 제한

- **초당 5건 제한**: 스크립트에서 자동으로 0.25초 간격 유지
- **최대 요청 횟수**: 기본값 50회 (약 45,000개 데이터)
- **일일 조회 제한**: Kiwoom API 정책에 따라 제한될 수 있음

### 데이터 제공 기간

Kiwoom API의 과거 데이터 제공 기간은 계좌 등급에 따라 다를 수 있습니다:

- **일반 계좌**: 최근 수개월 ~ 1년
- **프리미엄 계좌**: 더 긴 기간 제공 가능

1년 전 데이터가 조회되지 않을 경우:
1. 오늘부터 매일 데이터 수집 시작
2. DB에 저장하여 히스토리 누적
3. 시간이 지나면서 자체 데이터베이스 구축

## 🐛 문제 해결

### ❌ "ActiveX 컨트롤 생성 실패"

**원인:** OCX가 등록되지 않음

**해결:**
```cmd
# 관리자 권한으로 명령 프롬프트 실행
regsvr32 C:\OpenApi\KHOpenAPI64.ocx
```

### ❌ "로그인 실패" (0x8000FFFF)

**원인:** 다른 Kiwoom 프로세스와 충돌

**해결:**
1. 작업 관리자에서 모든 Kiwoom 프로세스 종료
2. PC 재부팅
3. 스크립트 재실행

### ❌ "데이터가 비어있습니다"

**원인:**
- 장 시간 외 조회
- 종목코드 오류
- 계좌 권한 부족

**해결:**
1. 평일 09:00 ~ 15:30 (장 시간) 중 테스트
2. 종목코드 확인 (6자리)
3. Kiwoom 계좌 권한 확인

### ❌ "32비트 Python 경고"

**원인:** 32비트 Python 사용

**해결:**
1. https://www.python.org/downloads/ 에서 64비트 Python 다운로드
2. 64비트 Python으로 재실행

## 📚 참고 자료

- [64비트 Kiwoom Open API GitHub](https://github.com/teranum/64bit-kiwoom-openapi)
- [키움증권 Open API 가이드](https://www.kiwoom.com/h/customer/download/VOpenApiInfoView)
- [프로젝트 64비트 OpenAPI 가이드](tests/manual/README_64BIT_OPENAPI.md)

## 📝 TR 코드 참고

| TR 코드 | 설명 | 용도 |
|---------|------|------|
| OPT10080 | 주식분봉조회 | 1, 3, 5, 10, 15, 30, 45, 60분봉 |
| OPT10081 | 주식일봉조회 | 일봉 데이터 |
| OPT10082 | 주식주봉조회 | 주봉 데이터 |
| OPT10083 | 주식월봉조회 | 월봉 데이터 |

## 💡 다음 단계

테스트 성공 후:

1. **데이터베이스 저장**
   - SQLite, PostgreSQL 등에 저장
   - 히스토리 관리

2. **스케줄러 추가**
   - 매일 자동 데이터 수집
   - 실시간 데이터 업데이트

3. **다종목 확장**
   - 여러 종목 동시 수집
   - KOSPI 200, KOSDAQ 150 등

4. **분석 시스템 연동**
   - 기술적 지표 계산
   - AI 모델 학습 데이터

## 📄 라이센스

이 테스트 스크립트는 교육 및 개발 목적으로 제공됩니다.
키움증권 Open API 사용 시 키움증권의 이용약관을 준수해야 합니다.

---

**작성일:** 2025-01-07
**작성자:** AutoTrade Pro Team
**버전:** 1.0.0
